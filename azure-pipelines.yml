# =============================================================
# Zordrax Frontend CI/CD
# Correct Node.js → Next.js 15 Standalone Deployment
# =============================================================

trigger:
  branches:
    include:
      - main

pool:
  vmImage: "ubuntu-latest"

variables:
- group: zordrax-analytica-dev-secrets
- name: appName
  value: "zordrax-frontend"
- name: environment
  value: "dev"
- name: SERVICE_CONNECTION
  value: "zordrax-analytica-dev-conn"
- name: RESOURCE_GROUP
  value: "zordrax-analytica-dev-rg"
- name: PLAN_NAME
  value: "zordrax-linux-plan"
- name: LOCATION
  value: "westeurope"
- name: NEXT_PUBLIC_ONBOARDING_API_URL
  value: "https://zordrax-onboarding-agent-zordrax-analytica-dev.azurewebsites.net/api/v5"

# =============================================================
# Build Stage
# =============================================================
stages:
- stage: Build
  jobs:
  - job: BuildFrontend
    timeoutInMinutes: 120
    steps:

    - checkout: self

    - task: NodeTool@0
      inputs:
        versionSpec: "20.x"

    - script: |
        echo "NEXT_PUBLIC_ONBOARDING_API_URL=$(NEXT_PUBLIC_ONBOARDING_API_URL)" > .env.local
        export NEXT_OUTPUT=standalone
        npm ci
        npm run build
      displayName: "Build Next.js (standalone mode)"

    # PACKAGE CORRECT STANDALONE BUNDLE
    - script: |
        rm -rf out
        mkdir out

        # 1 — Copy standalone server bundle
        cp -R .next/standalone/* out/

        # 2 — Copy static files
        mkdir -p out/.next
        cp -R .next/static out/.next/static

        # 3 — Copy public
        cp -R public out/public

        # 4 — Copy env and package manifests
        cp package.json out/package.json
        cp package-lock.json out/package-lock.json
      displayName: "Prepare deployment bundle"

    - task: ArchiveFiles@2
      inputs:
        rootFolderOrFile: "out"
        includeRootFolder: false
        archiveType: zip
        archiveFile: "$(Build.ArtifactStagingDirectory)/frontend.zip"
        replaceExistingArchive: true

    - publish: "$(Build.ArtifactStagingDirectory)/frontend.zip"
      artifact: drop

# =============================================================
# Deploy Stage
# =============================================================
- stage: Deploy
  dependsOn: Build
  jobs:
  - job: DeployFrontend
    steps:

    - download: current
      artifact: drop

    - task: AzureCLI@2
      displayName: "Ensure App Service exists"
      inputs:
        azureSubscription: "$(SERVICE_CONNECTION)"
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -ex

          # Create RG
          az group create -n "$(RESOURCE_GROUP)" -l "$(LOCATION)"

          # Create plan
          az appservice plan create \
            --name "$(PLAN_NAME)" \
            --resource-group "$(RESOURCE_GROUP)" \
            --sku B1 --is-linux || true

          # Create App
          app_name="$(appName)-$(environment)"
          az webapp create \
            --name "$app_name" \
            --resource-group "$(RESOURCE_GROUP)" \
            --plan "$(PLAN_NAME)" \
            --runtime "NODE:20-lts" || true

          # ENV VARS
          az webapp config appsettings set \
            --resource-group "$(RESOURCE_GROUP)" \
            --name "$app_name" \
            --settings \
              NODE_ENV=production \
              PORT=8080 \
              WEBSITE_RUN_FROM_PACKAGE=1 \
              NEXT_PUBLIC_ONBOARDING_API_URL="$(NEXT_PUBLIC_ONBOARDING_API_URL)"

          # Startup command
          az webapp config set \
            --resource-group "$(RESOURCE_GROUP)" \
            --name "$app_name" \
            --startup-file "node server.js"

    - task: AzureWebApp@1
      displayName: "Deploy Frontend"
      inputs:
        azureSubscription: "$(SERVICE_CONNECTION)"
        appType: webAppLinux
        appName: "$(appName)-$(environment)"
        package: "$(Pipeline.Workspace)/drop/frontend.zip"

    - script: sleep 30
      displayName: "Warm Up"

    - bash: |
        curl -I "https://$(appName)-$(environment).azurewebsites.net"
      displayName: "Health Check"
