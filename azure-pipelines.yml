# =============================================================
# Zordrax-Analytica | Frontend CI/CD (FINAL FIXED)
# =============================================================

trigger:
  branches:
    include:
      - main

pool:
  vmImage: "ubuntu-latest"

variables:
- group: zordrax-analytica-dev-secrets

- name: appName
  value: "zordrax-frontend"

- name: environment
  value: "dev"

- name: SERVICE_CONNECTION
  value: "zordrax-analytica-dev-spn"

- name: RESOURCE_GROUP
  value: "zordrax-analytica-dev-rg"

- name: PLAN_NAME
  value: "zordrax-linux-plan"

- name: LOCATION
  value: "westeurope"

# Frontend env values
- name: NEXT_PUBLIC_ONBOARDING_API_URL
  value: "https://zordrax-onboarding-agent-zordrax-analytica-dev.azurewebsites.net/api/v5"

- name: NEXT_PUBLIC_BACKEND_URL
  value: "https://zordrax-onboarding-agent-zordrax-analytica-dev.azurewebsites.net"

- name: NEXT_PUBLIC_AUTH_URL
  value: "https://zordrax-auth-agent-zordrax-analytica-dev.azurewebsites.net/api/v5"

- name: NEXT_PUBLIC_CLIENT_ID
  value: "ZordraxWebAppDev"

stages:

# =============================================================
# BUILD STAGE
# =============================================================
- stage: Build
  displayName: "Build Frontend"
  jobs:
  - job: Build
    timeoutInMinutes: 120
    pool:
      vmImage: "ubuntu-latest"

    steps:
    - checkout: self
      persistCredentials: true

    - script: |
        rm -rf .next
        rm -rf .next/cache
      displayName: "Clear Next.js cache"

    - script: mkdir -p "$(Pipeline.Workspace)/.npm"
      displayName: "Prep NPM cache"

    - task: Cache@2
      inputs:
        key: 'npm | "$(Agent.OS)" | package-lock.json'
        path: "$(Pipeline.Workspace)/.npm"
      displayName: "Cache npm packages"

    - task: NodeTool@0
      inputs:
        versionSpec: "20.x"
      displayName: "Install NodeJS"

    - script: |
        set -ex
        cat > .env.local <<EOF
        NEXT_PUBLIC_ONBOARDING_API_URL=$(NEXT_PUBLIC_ONBOARDING_API_URL)
        NEXT_PUBLIC_BACKEND_URL=$(NEXT_PUBLIC_BACKEND_URL)
        NEXT_PUBLIC_AUTH_URL=$(NEXT_PUBLIC_AUTH_URL)
        NEXT_PUBLIC_CLIENT_ID=$(NEXT_PUBLIC_CLIENT_ID)
        EOF

        export NEXT_OUTPUT=standalone
        npm ci
        npm run build
      displayName: "Build Next.js"
      env:
        NPM_CONFIG_CACHE: "$(Pipeline.Workspace)/.npm"

    - script: |
        set -ex
        rm -rf out
        mkdir -p out

        # Standalone server (includes Node server.js etc.)
        cp -R .next/standalone/. out/

        # Static assets
        mkdir -p out/.next
        cp -R .next/static out/.next/static

        # App router server files (wizard, etc.)
        mkdir -p out/.next/server
        cp -R .next/server/app out/.next/server/app

        # Public assets
        cp -R public out/public || true

        # Package metadata
        cp package.json out/package.json
        cp package-lock.json out/package-lock.json || true
      displayName: "Package Next.js standalone build"

    - task: ArchiveFiles@2
      displayName: "Archive deployment output"
      inputs:
        rootFolderOrFile: "$(System.DefaultWorkingDirectory)/out"
        includeRootFolder: false
        archiveType: zip
        archiveFile: "$(Build.ArtifactStagingDirectory)/$(appName).zip"

    - publish: "$(Build.ArtifactStagingDirectory)/$(appName).zip"
      artifact: drop

# =============================================================
# DEPLOY STAGE
# =============================================================
- stage: Deploy
  displayName: "Deploy Frontend"
  dependsOn: Build

  jobs:
  - job: Deploy
    pool:
      vmImage: "ubuntu-latest"

    steps:
    - download: current
      artifact: drop

    - task: AzureCLI@2
      displayName: "Ensure App Service exists + apply env vars"
      inputs:
        azureSubscription: "$(SERVICE_CONNECTION)"
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -ex

          resource_group="$(RESOURCE_GROUP)"
          plan_name="$(PLAN_NAME)"
          location="$(LOCATION)"
          app_name="$(appName)-$(environment)"

          echo "Ensuring resource group..."
          az group create --name "${resource_group}" --location "${location}" >/dev/null

          echo "Ensuring App Service plan..."
          az appservice plan create \
            --name "${plan_name}" \
            --resource-group "${resource_group}" \
            --is-linux \
            --sku B1 >/dev/null || true

          echo "Ensuring Web App..."
          az webapp create \
            --name "${app_name}" \
            --resource-group "${resource_group}" \
            --plan "${plan_name}" \
            --runtime "NODE|20-lts" >/dev/null || true

          echo "Applying frontend App Settings (all NEXT_* vars)..."
          az webapp config appsettings set \
            --name "${app_name}" \
            --resource-group "${resource_group}" \
            --settings \
              NODE_ENV="production" \
              PORT=8080 \
              NEXT_PUBLIC_ONBOARDING_API_URL="$(NEXT_PUBLIC_ONBOARDING_API_URL)" \
              NEXT_PUBLIC_BACKEND_URL="$(NEXT_PUBLIC_BACKEND_URL)" \
              NEXT_PUBLIC_AUTH_URL="$(NEXT_PUBLIC_AUTH_URL)" \
              NEXT_PUBLIC_CLIENT_ID="$(NEXT_PUBLIC_CLIENT_ID)" >/dev/null

    - task: AzureWebApp@1
      displayName: "Deploy frontend package"
      inputs:
        azureSubscription: "$(SERVICE_CONNECTION)"
        appType: "webAppLinux"
        appName: "$(appName)-$(environment)"
        package: "$(Pipeline.Workspace)/drop/$(appName).zip"

    - bash: |
        set -ex
        echo "Health check..."
        curl -I "https://$(appName)-$(environment).azurewebsites.net" || true
      displayName: "Health check"
