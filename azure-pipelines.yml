# ==========================================================
# Zordrax-Analytica | Frontend Next.js Deployment Pipeline
# Next.js 15 → Standalone Build → Zip → Azure Web App Deploy
# ==========================================================

trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

variables:
  appName: "zordrax-frontend-dev"
  serviceConnection: "zordrax-analytica-dev-spn"
  artifactName: "frontend-build"
  zipPath: "$(Build.ArtifactStagingDirectory)/frontend.zip"

steps:

# 1️⃣ Install Node.js 20 (required by Azure App Service)
- task: NodeTool@0
  inputs:
    versionSpec: "20.x"
  displayName: "Use Node.js 20"

# 2️⃣ Install dependencies
- script: |
    npm ci
  displayName: "Install dependencies"

# 3️⃣ Build Next.js (with standalone output)
- script: |
    npm run build
  displayName: "Build Next.js app"

# 4️⃣ Prepare output folder for deployment
- script: |
    rm -rf out
    mkdir -p out

    # Copy standalone server build
    cp -R .next/standalone/* out/

    # Copy static assets
    mkdir -p out/.next
    cp -R .next/static out/.next/static

    # Copy public assets
    cp -R public out/public
  displayName: "Prepare deployment package"

# 5️⃣ Zip deployment package
- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: "out"
    includeRootFolder: false
    archiveType: zip
    archiveFile: "$(zipPath)"
    replaceExistingArchive: true
  displayName: "Create deployment ZIP"

# 6️⃣ Publish artifact
- task: PublishPipelineArtifact@1
  inputs:
    targetPath: "$(Build.ArtifactStagingDirectory)"
    artifact: "$(artifactName)"
  displayName: "Publish artifact"

# 7️⃣ Deploy to Azure Web App
- task: AzureWebApp@1
  inputs:
    azureSubscription: "$(serviceConnection)"
    appName: "$(appName)"
    package: "$(zipPath)"
    startupCommand: "node server.js"
  displayName: "Deploy to Azure Web App"
