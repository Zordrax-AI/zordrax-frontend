# ==========================================================
# Zordrax Frontend Pipeline - Next.js 15 (Azure App Service)
# ==========================================================

trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

variables:
  appName: "zordrax-frontend-dev"
  serviceConnection: "zordrax-analytica-dev-spn"
  artifactName: "frontend-app"
  zipPath: "$(Build.ArtifactStagingDirectory)/frontend.zip"
  stagingDir: "$(Build.ArtifactStagingDirectory)/site"

steps:

# 1. Install Node 20
- task: NodeTool@0
  inputs:
    versionSpec: "20.x"
  displayName: "Use Node.js 20"

# 2. Install dependencies
- script: |
    npm ci
  displayName: "Install dependencies"

# 3. Build Next.js
- script: |
    npm run build
  displayName: "Build Next.js app"

# 4. Prepare deployment folder at archive root (no /out nesting)
- script: |
    rm -rf "$(stagingDir)"
    mkdir -p "$(stagingDir)"

    cp -R .next "$(stagingDir)/.next"
    cp -R node_modules "$(stagingDir)/node_modules"
    cp -R public "$(stagingDir)/public"
    cp package.json "$(stagingDir)/package.json"
    cp package-lock.json "$(stagingDir)/package-lock.json"
    if [ -f next.config.mjs ]; then cp next.config.mjs "$(stagingDir)/next.config.mjs"; fi
  displayName: "Prepare deployment folder"

# 5. Zip build (contents land directly in /home/site/wwwroot)
- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: "$(stagingDir)"
    includeRootFolder: false
    archiveType: zip
    archiveFile: "$(zipPath)"
    replaceExistingArchive: true
  displayName: "Create ZIP"

# 6. Publish artifact
- task: PublishPipelineArtifact@1
  inputs:
    targetPath: "$(Build.ArtifactStagingDirectory)"
    artifact: "$(artifactName)"

# 7. Deploy to Azure App Service (no Oryx build; run Next directly)
- task: AzureWebApp@1
  inputs:
    azureSubscription: "$(serviceConnection)"
    appName: "$(appName)"
    package: "$(zipPath)"
    startupCommand: "cd /home/site/wwwroot && node node_modules/next/dist/bin/next start --port $PORT"
  displayName: "Deploy to Azure Web App"
