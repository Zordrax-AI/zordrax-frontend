# ==========================================================
# Zordrax Frontend Pipeline â€“ FINAL VERIFIED STANDALONE VERSION
# ==========================================================

trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

variables:
  appName: "zordrax-frontend-dev"
  serviceConnection: "zordrax-analytica-dev-spn"
  artifactName: "frontend-app"
  zipPath: "$(Build.ArtifactStagingDirectory)/frontend.zip"

steps:

# 1. Node 20
- task: NodeTool@0
  inputs:
    versionSpec: "20.x"
  displayName: "Use Node.js 20"

# 2. Install dependencies
- script: npm ci
  displayName: "Install dependencies"

# 3. Build standalone output
- script: npm run build
  displayName: "Next.js build (standalone)"

# 4. Prepare correct standalone deployment folder
- script: |
    rm -rf out
    mkdir -p out
    mkdir -p out/.next
    mkdir -p out/.next/server
    mkdir -p out/.next/static

    echo ">>> Copying standalone root bundle"
    cp -R .next/standalone/* out/

    echo ">>> Copying static assets"
    cp -R .next/static/* out/.next/static/

    echo ">>> Copying server output"
    cp -R .next/server/* out/.next/server/

    echo ">>> Copying manifest files"
    cp .next/BUILD_ID out/.next/BUILD_ID
    cp .next/routes-manifest.json out/.next/routes-manifest.json
    cp .next/build-manifest.json out/.next/build-manifest.json
    cp .next/prerender-manifest.json out/.next/prerender-manifest.json
    cp .next/middleware-manifest.json out/.next/middleware-manifest.json
    cp .next/app-build-manifest.json out/.next/app-build-manifest.json 2>/dev/null || true

    echo ">>> Copying public folder"
    cp -R public out/public || true

    echo ">>> FINAL DEPLOY CONTENTS:"
    ls -R out
  displayName: "Prepare standalone deployment correctly"


# 5. Create deployment ZIP
- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: "out"
    includeRootFolder: false
    archiveType: zip
    archiveFile: "$(zipPath)"
    replaceExistingArchive: true

# 6. Publish artifact for pipeline logs
- task: PublishPipelineArtifact@1
  inputs:
    targetPath: "$(Build.ArtifactStagingDirectory)"
    artifact: "$(artifactName)"

# 7. Deploy to Azure Web App
- task: AzureWebApp@1
  inputs:
    azureSubscription: "$(serviceConnection)"
    appName: "$(appName)"
    package: "$(zipPath)"
    startupCommand: "node server.js"
  displayName: "Deploy to Azure App Service"
