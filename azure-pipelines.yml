# =============================================================
# Zordrax-Analytica | Frontend CI/CD (Stable)
# Build → Package → Deploy
# =============================================================

trigger:
  branches:
    include:
      - main

pool:
  vmImage: "ubuntu-latest"

variables:
- group: zordrax-analytica-dev-secrets
- name: appName
  value: "zordrax-frontend"
- name: environment
  value: "dev"
- name: SERVICE_CONNECTION
  value: "zordrax-analytica-dev-conn"
- name: RESOURCE_GROUP
  value: "zordrax-analytica-dev-rg"
- name: PLAN_NAME
  value: "zordrax-linux-plan"
- name: LOCATION
  value: "westeurope"
- name: NEXT_PUBLIC_ONBOARDING_API_URL
  value: "https://zordrax-onboarding-agent-zordrax-analytica-dev.azurewebsites.net/api/v5"

# =============================================================
# Stage 1: Build
# =============================================================
stages:
- stage: Build
  displayName: "Build Frontend v5"
  jobs:
  - job: Build
    timeoutInMinutes: 120
    pool:
      vmImage: "ubuntu-latest"
    steps:

    - checkout: self
      persistCredentials: true

    # CLEAN ANY OLD NEXT.JS CACHE
    - script: |
        echo "Cleaning stale Next.js build cache..."
        rm -rf .next
        rm -rf .next/cache
      displayName: "Clear Next.js build cache"

    # PREP NPM CACHE
    - script: mkdir -p "$(Pipeline.Workspace)/.npm"
      displayName: "Prep npm cache directory"

    - task: Cache@2
      displayName: "Cache npm packages"
      inputs:
        key: 'npm | "$(Agent.OS)" | package-lock.json'
        restoreKeys: |
          npm | "$(Agent.OS)"
        path: "$(Pipeline.Workspace)/.npm"

    - task: NodeTool@0
      inputs:
        versionSpec: "20.x"
      displayName: "Install Node.js"

    # BUILD
    - script: |
        set -ex
        echo "NEXT_PUBLIC_ONBOARDING_API_URL=$(NEXT_PUBLIC_ONBOARDING_API_URL)" > .env.local
        export NEXT_OUTPUT=standalone
        npm ci
        npm run build
      displayName: "Build Next.js frontend (standalone mode)"
      env:
        NPM_CONFIG_CACHE: "$(Pipeline.Workspace)/.npm"

    # PACKAGE STANDALONE OUTPUT
    - script: |
        set -ex
        rm -rf out
        mkdir -p out

        # Next.js standalone bundle
        cp -R .next/standalone/. out/
        mkdir -p out/.next
        cp -R .next/static out/.next/static

        # Public folder
        if [ -d public ]; then
          cp -R public out/public
        fi

        # include package.json and lock file
        cp package.json out/package.json
        if [ -f package-lock.json ]; then
          cp package-lock.json out/package-lock.json
        fi
      displayName: "Package standalone bundle"

    - task: ArchiveFiles@2
      displayName: "Archive artifact"
      inputs:
        rootFolderOrFile: "$(System.DefaultWorkingDirectory)/out"
        includeRootFolder: false
        archiveType: zip
        archiveFile: "$(Build.ArtifactStagingDirectory)/$(appName).zip"
        replaceExistingArchive: true

    - publish: "$(Build.ArtifactStagingDirectory)/$(appName).zip"
      artifact: drop

# =============================================================
# Stage 2: Deploy
# =============================================================
- stage: Deploy
  displayName: "Deploy Frontend to Azure"
  dependsOn: Build
  jobs:
  - job: Deploy
    timeoutInMinutes: 120
    pool:
      vmImage: "ubuntu-latest"
    steps:

    - download: current
      artifact: drop

    - task: AzureCLI@2
      displayName: "Ensure App Service exists"
      inputs:
        azureSubscription: "$(SERVICE_CONNECTION)"
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -ex

          # RESOURCE GROUP
          az group create --name "$(RESOURCE_GROUP)" --location "$(LOCATION)" >/dev/null

          # PLAN
          az appservice plan create \
            --name "$(PLAN_NAME)" \
            --resource-group "$(RESOURCE_GROUP)" \
            --is-linux --sku B1 >/dev/null || true

          # APP
          app_name="$(appName)-$(environment)"
          runtime="NODE|20-lts"

          az webapp create \
            --name "$app_name" \
            --resource-group "$(RESOURCE_GROUP)" \
            --plan "$(PLAN_NAME)" \
            --runtime "$runtime" >/dev/null || true

          # ENV VARS
          az webapp config appsettings set \
            --name "$app_name" \
            --resource-group "$(RESOURCE_GROUP)" \
            --settings \
              NODE_ENV=production \
              PORT=8080 \
              SCM_DO_BUILD_DURING_DEPLOYMENT=false \
              WEBSITE_RUN_FROM_PACKAGE=1 \
              NEXT_PUBLIC_ONBOARDING_API_URL="$(NEXT_PUBLIC_ONBOARDING_API_URL)" >/dev/null

          az webapp config set \
            --name "$app_name" \
            --resource-group "$(RESOURCE_GROUP)" \
            --startup-file "node server.js" >/dev/null

    - task: AzureWebApp@1
      displayName: "Deploy frontend package"
      inputs:
        azureSubscription: "$(SERVICE_CONNECTION)"
        appType: webAppLinux
        appName: "$(appName)-$(environment)"
        package: "$(Pipeline.Workspace)/drop/$(appName).zip"

    - script: |
        echo "Waiting 60 seconds for warm-up..."
        sleep 60
      displayName: "Warm-up delay"

    - bash: |
        host="$(appName)-$(environment).azurewebsites.net"
        echo "Checking $host"
        curl --retry 5 --retry-delay 10 --max-time 10 --fail -I "https://$host" || echo "Warning: health check failed (non-blocking)"
      displayName: "Health check"
