# =============================================================
# Zordrax-Analytica | Frontend CI/CD Pipeline (Next.js)
# Phase 2 Final – Build → Package → Deploy (Self-Provisioning)
# =============================================================

trigger:
  branches:
    include:
      - main

pool:
  vmImage: "ubuntu-latest"

variables:
- group: zordrax-analytica-dev-secrets
- name: appName
  value: "zordrax-frontend"
- name: environment
  value: "dev"
- name: SERVICE_CONNECTION
  value: "zordrax-analytica-dev-conn"   # must match Azure DevOps connection
- name: RESOURCE_GROUP
  value: "zordrax-analytica-dev-rg"
- name: PLAN_NAME
  value: "zordrax-linux-plan"
- name: LOCATION
  value: "westeurope"

# -------------------------------------------------------------
# Stage 1 – Build Frontend
# -------------------------------------------------------------
stages:
- stage: Build
  displayName: "Build Frontend"
  jobs:
  - job: Build
    pool:
      vmImage: "ubuntu-latest"
    steps:
    - checkout: self
      persistCredentials: true

    - task: NodeTool@0
      inputs:
        versionSpec: "20.x"
      displayName: "Install Node.js"

    - script: |
        set -ex
        export NEXT_OUTPUT=standalone
        npm ci
        npm run build

        # Prefer standalone Node bundle when available; otherwise fall back to static export in out/
        if [ -d ".next/standalone" ]; then
          rm -rf out
          mkdir -p out/.next

          app_root=$(dirname "$(find .next/standalone -type f -name server.js | head -n 1)")
          if [ -z "$app_root" ]; then
            echo "Standalone folder detected but server.js missing."
            exit 1
          fi

          cp -R "$app_root/." out/
          cp -R .next/static out/.next/static
          if [ -d public ]; then
            cp -R public out/public
          fi
        else
          echo "Standalone bundle not found; assuming static export already created ./out."
          if [ ! -d "out" ]; then
            echo "No standalone build and ./out missing. Cannot stage artifact."
            exit 1
          fi
        fi
        if [ -f "out/server.js" ]; then
          startup_cmd="pm2 start /home/site/wwwroot/server.js --no-daemon"
        else
          startup_cmd="pm2 serve /home/site/wwwroot --no-daemon --spa"
        fi

        echo "##vso[task.setvariable variable=appStartupCommand;isOutput=true]$startup_cmd"
      displayName: "Install dependencies, build, and stage artifact"
      name: BuildAndStage

    - task: ArchiveFiles@2
      displayName: "Package site"
      inputs:
        rootFolderOrFile: "$(System.DefaultWorkingDirectory)/out"
        includeRootFolder: false
        archiveType: zip
        archiveFile: "$(Build.ArtifactStagingDirectory)/$(appName).zip"
        replaceExistingArchive: true

    - publish: "$(Build.ArtifactStagingDirectory)/$(appName).zip"
      artifact: "drop"

# -------------------------------------------------------------
# Stage 2 – Deploy to Azure Web App (Self-Provisioning)
# -------------------------------------------------------------
- stage: Deploy
  displayName: "Deploy Frontend (App Service)"
  dependsOn: Build
  jobs:
  - job: Deploy
    pool:
      vmImage: "ubuntu-latest"
    variables:
      app_startup: $[ stageDependencies.Build.Build.outputs['BuildAndStage.appStartupCommand'] ]
    steps:
    - download: current
      artifact: drop

    # Ensure Web App exists (idempotent)
    - task: AzureCLI@2
      displayName: "Ensure Frontend App Service exists"
      name: ProvisionApp
      inputs:
        azureSubscription: "$(SERVICE_CONNECTION)"
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -ex
          resource_group="$(RESOURCE_GROUP)"
          plan_name="$(PLAN_NAME)"
          app_name="$(appName)-$(environment)"
          location="$(LOCATION)"
          runtime="NODE|20-lts"

          echo "Ensuring resource group..."
          az group create --name "$resource_group" --location "$location" >/dev/null

          echo "Ensuring App Service plan..."
          az appservice plan create \
            --name "$plan_name" \
            --resource-group "$resource_group" \
            --is-linux \
            --sku B1 >/dev/null || true

          echo "Ensuring Web App..."
          az webapp create \
            --name "$app_name" \
            --resource-group "$resource_group" \
            --plan "$plan_name" \
            --runtime "$runtime" >/dev/null || true

          echo "Configuring Node runtime & startup..."
          az webapp config appsettings set \
            --name "$app_name" \
            --resource-group "$resource_group" \
            --settings SCM_DO_BUILD_DURING_DEPLOYMENT=false NODE_ENV=production PORT=8080 >/dev/null

          echo "Setting startup command to: $(app_startup)"
          az webapp config set \
            --name "$app_name" \
            --resource-group "$resource_group" \
            --startup-file "$(app_startup)" >/dev/null

          host=$(az webapp show --name "$app_name" --resource-group "$resource_group" --query defaultHostName -o tsv)
          echo "Web app host: $host"
          echo "##vso[task.setvariable variable=webAppHost]$host"

    # Deploy the built ZIP package
    - task: AzureWebApp@1
      displayName: "Deploy Next.js Frontend"
      inputs:
        azureSubscription: "$(SERVICE_CONNECTION)"
        appType: webAppLinux
        appName: "$(appName)-$(environment)"
        package: "$(Pipeline.Workspace)/drop/$(appName).zip"

    # Health Check after deploy
    - bash: |
        set -x
        host="$(webAppHost)"
        if [ -z "$host" ]; then
          host="$(appName)-$(environment).azurewebsites.net"
        fi
        uri="https://${host}"
        echo "Pinging ${uri} ..."
        for i in {1..10}; do
          http_status=$(curl -sS -o /dev/null -w "%{http_code}" "$uri" || echo "000")
          case "$http_status" in
            2*|3*)
              echo "✅ Health check passed."
              exit 0
              ;;
            *)
              echo "Attempt $i failed (status: $http_status). Retrying..."
              sleep 10
              ;;
          esac
        done
        echo "❌ Health check failed after 10 attempts."
        exit 1
      displayName: "Health Check Frontend"
